# 合约构造方法执行

发送交易的时,将参数编码后放到整个字节码的后边传送给节执行
```
pragma solidity ^0.4.22;
contract Demo2{
        int m  = 0;

        constructor(int y) public {
		    m = 15 + y;
    	}
        function add( int x ) public {
                m = m + x + 14 ;
        }
        function get() public view returns (int) {
                return m;
        }

}
```

使用上述代码做demo
```
deploy Demo2 1


//获取交易详情
getTransactionByHash 0xb2fce65797aec380412914ccaac3ad308525cc32649d499542e7a5fa3bfc73cd

0x60806040526000805534801561001457600080fd5b506040516020806101368339810180604052810190808051906020019092919050505080600f016000819055505060e6806100506000396000f3006080604052600436106049576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680636d4ce63c14604e57806387db03b7146076575b600080fd5b348015605957600080fd5b50606060a0565b6040518082815260200191505060405180910390f35b348015608157600080fd5b50609e6004803603810190808035906020019092919050505060a9565b005b60008054905090565b600e816000540101600081905550505600a165627a7a72305820e83d692a99afb7f08f5ab1d1cfc6f4f31dfde3634f3f43a849be551afb95a85d00290000000000000000000000000000000000000000000000000000000000000001

//包含全部数据，参数编码后在后面传递

getCode 0x59a041b5789e15f782acb244cf290f45014596f4

0x6080604052600436106049576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680636d4ce63c14604e57806387db03b7146076575b600080fd5b348015605957600080fd5b50606060a0565b6040518082815260200191505060405180910390f35b348015608157600080fd5b50609e6004803603810190808035906020019092919050505060a9565b005b60008054905090565b600e816000540101600081905550505600a165627a7a72305820e83d692a99afb7f08f5ab1d1cfc6f4f31dfde3634f3f43a849be551afb95a85d0029

//runtime和上面的Demo也是完全一样,因为要提供给用户的方法是一样的

```

通过web3j的代码也可以看到
```
https://github.com/ethereum/web3.js/blob/1.x/packages/web3-eth-contract/src/index.js

//发布部署合约
Contract.prototype.deploy = function(options, callback){

    options = options || {};

    options.arguments = options.arguments || [];
    options = this._getOrSetDefaultOptions(options);


    // throw error, if no "data" is specified
    if(!options.data) {
        if (typeof callback === 'function'){
            return callback(errors.ContractMissingDeployDataError());
        }
        throw errors.ContractMissingDeployDataError();
    }

    var constructor = _.find(this.options.jsonInterface, function (method) {
        return (method.type === 'constructor');
    }) || {};
    constructor.signature = 'constructor';

    return this._createTxObject.apply({
        method: constructor,
        parent: this,
        deployData: options.data,
        _ethAccounts: this.constructor._ethAccounts
    }, options.arguments);

};


//创建交易
Contract.prototype._createTxObject =  function _createTxObject(){
    var args = Array.prototype.slice.call(arguments);
    var txObject = {};

    if(this.method.type === 'function') {

        txObject.call = this.parent._executeMethod.bind(txObject, 'call');
        txObject.call.request = this.parent._executeMethod.bind(txObject, 'call', true); // to make batch requests

    }

    txObject.send = this.parent._executeMethod.bind(txObject, 'send');
    txObject.send.request = this.parent._executeMethod.bind(txObject, 'send', true); // to make batch requests
    txObject.encodeABI = this.parent._encodeMethodABI.bind(txObject);
    txObject.estimateGas = this.parent._executeMethod.bind(txObject, 'estimate');

    if (args && this.method.inputs && args.length !== this.method.inputs.length) {
        if (this.nextMethod) {
            return this.nextMethod.apply(null, args);
        }
        throw errors.InvalidNumberOfParams(args.length, this.method.inputs.length, this.method.name);
    }

    txObject.arguments = args || [];
    txObject._method = this.method;
    txObject._parent = this.parent;
    txObject._ethAccounts = this.parent.constructor._ethAccounts || this._ethAccounts;

    if(this.deployData) {
        txObject._deployData = this.deployData;
    }

    return txObject;
};

//encode ABI
Contract.prototype._encodeMethodABI = function _encodeMethodABI() {
    var methodSignature = this._method.signature,
        args = this.arguments || [];

    var signature = false,
        paramsABI = this._parent.options.jsonInterface.filter(function (json) {
            return ((methodSignature === 'constructor' && json.type === methodSignature) ||
                ((json.signature === methodSignature || json.signature === methodSignature.replace('0x','') || json.name === methodSignature) && json.type === 'function'));
        }).map(function (json) {
            var inputLength = (_.isArray(json.inputs)) ? json.inputs.length : 0;

            if (inputLength !== args.length) {
                throw new Error('The number of arguments is not matching the methods required number. You need to pass '+ inputLength +' arguments.');
            }

            if (json.type === 'function') {
                signature = json.signature;
            }
            return _.isArray(json.inputs) ? json.inputs : [];
        }).map(function (inputs) {
            return abi.encodeParameters(inputs, args).replace('0x','');
        })[0] || '';

    // return constructor
    if(methodSignature === 'constructor') {
        if(!this._deployData)
            throw new Error('The contract has no contract data option set. This is necessary to append the constructor parameters.');

        if(!this._deployData.startsWith('0x')) {
            this._deployData = '0x' + this._deployData;
        }

        return this._deployData + paramsABI;

    }

    // return method
    var returnValue = (signature) ? signature + paramsABI : paramsABI;

    if(!returnValue) {
        throw new Error('Couldn\'t find a matching contract method named "'+ this._method.name +'".');
    }

    return returnValue;
};


```

最后64位表示输入参数;

查看整个汇编代码
```
.code
  PUSH 80			contract Demo2{\n        int m...
  PUSH 40			contract Demo2{\n        int m...
  MSTORE 			contract Demo2{\n        int m...
  PUSH 0			0
  DUP1 			int m  = 0
  SSTORE 			int m  = 0
  CALLVALUE 			constructor(int y) public {\n\...
  DUP1 			olidity ^
  ISZERO 			a
  PUSH [tag] 1			a
  JUMPI 			a
  PUSH 0			a
  DUP1 			n
  REVERT 			.22;\ncontrac
tag 1			a
  JUMPDEST 			a
  POP 			constructor(int y) public {\n\...
  PUSH 40			constructor(int y) public {\n\...
  MLOAD 			constructor(int y) public {\n\...
  PUSH 20			constructor(int y) public {\n\...
  DUP1 			constructor(int y) public {\n\...
  PUSHSIZE 			constructor(int y) public {\n\...
  DUP4 			constructor(int y) public {\n\...
  CODECOPY 			constructor(int y) public {\n\...
  DUP2 			constructor(int y) public {\n\...
  ADD 			constructor(int y) public {\n\...
  DUP1 			constructor(int y) public {\n\...
  PUSH 40			constructor(int y) public {\n\...
  MSTORE 			constructor(int y) public {\n\...
  DUP2 			constructor(int y) public {\n\...
  ADD 			constructor(int y) public {\n\...
  SWAP1 			constructor(int y) public {\n\...
  DUP1 			constructor(int y) public {\n\...
  DUP1 			constructor(int y) public {\n\...
  MLOAD 			constructor(int y) public {\n\...
  SWAP1 			constructor(int y) public {\n\...
  PUSH 20			constructor(int y) public {\n\...
  ADD 			constructor(int y) public {\n\...
  SWAP1 			constructor(int y) public {\n\...
  SWAP3 			constructor(int y) public {\n\...
  SWAP2 			constructor(int y) public {\n\...
  SWAP1 			constructor(int y) public {\n\...
  POP 			constructor(int y) public {\n\...
  POP 			constructor(int y) public {\n\...
  POP 			constructor(int y) public {\n\...
  DUP1 			y
  PUSH F			15
  ADD 			15 + y
  PUSH 0			m
  DUP2 			m = 15 + y
  SWAP1 			m = 15 + y
  SSTORE 			m = 15 + y
  POP 			m = 15 + y
  POP 			constructor(int y) public {\n\...
  PUSH #[$] 0000000000000000000000000000000000000000000000000000000000000000			contract Demo2{\n        int m...
  DUP1 			contract Demo2{\n        int m...
  PUSH [$] 0000000000000000000000000000000000000000000000000000000000000000			contract Demo2{\n        int m...
  PUSH 0			contract Demo2{\n        int m...
  CODECOPY 			contract Demo2{\n        int m...
  PUSH 0			contract Demo2{\n        int m...
  RETURN 			contract Demo2{\n        int m...
.data
  0:
    .code
      PUSH 80			contract Demo2{\n        int m...
      PUSH 40			contract Demo2{\n        int m...
      MSTORE 			contract Demo2{\n        int m...
      PUSH 4			contract Demo2{\n        int m...
      CALLDATASIZE 			contract Demo2{\n        int m...
      LT 			contract Demo2{\n        int m...
      PUSH [tag] 1			contract Demo2{\n        int m...
      JUMPI 			contract Demo2{\n        int m...
      PUSH 0			contract Demo2{\n        int m...
      CALLDATALOAD 			contract Demo2{\n        int m...
      PUSH 100000000000000000000000000000000000000000000000000000000			contract Demo2{\n        int m...
      SWAP1 			contract Demo2{\n        int m...
      DIV 			contract Demo2{\n        int m...
      PUSH FFFFFFFF			contract Demo2{\n        int m...
      AND 			contract Demo2{\n        int m...
      DUP1 			contract Demo2{\n        int m...
      PUSH 6D4CE63C			contract Demo2{\n        int m...
      EQ 			contract Demo2{\n        int m...
      PUSH [tag] 2			contract Demo2{\n        int m...
      JUMPI 			contract Demo2{\n        int m...
      DUP1 			contract Demo2{\n        int m...
      PUSH 87DB03B7			contract Demo2{\n        int m...
      EQ 			contract Demo2{\n        int m...
      PUSH [tag] 3			contract Demo2{\n        int m...
      JUMPI 			contract Demo2{\n        int m...
    tag 1			contract Demo2{\n        int m...
      JUMPDEST 			contract Demo2{\n        int m...
      PUSH 0			contract Demo2{\n        int m...
      DUP1 			contract Demo2{\n        int m...
      REVERT 			contract Demo2{\n        int m...
    tag 2			function get() public view ret...
      JUMPDEST 			function get() public view ret...
      CALLVALUE 			function get() public view ret...
      DUP1 			olidity ^
      ISZERO 			a
      PUSH [tag] 4			a
      JUMPI 			a
      PUSH 0			a
      DUP1 			n
      REVERT 			.22;\ncontrac
    tag 4			a
      JUMPDEST 			a
      POP 			function get() public view ret...
      PUSH [tag] 5			function get() public view ret...
      PUSH [tag] 6			function get() public view ret...
      JUMP 			function get() public view ret...
    tag 5			function get() public view ret...
      JUMPDEST 			function get() public view ret...
      PUSH 40			function get() public view ret...
      MLOAD 			function get() public view ret...
      DUP1 			function get() public view ret...
      DUP3 			function get() public view ret...
      DUP2 			function get() public view ret...
      MSTORE 			function get() public view ret...
      PUSH 20			function get() public view ret...
      ADD 			function get() public view ret...
      SWAP2 			function get() public view ret...
      POP 			function get() public view ret...
      POP 			function get() public view ret...
      PUSH 40			function get() public view ret...
      MLOAD 			function get() public view ret...
      DUP1 			function get() public view ret...
      SWAP2 			function get() public view ret...
      SUB 			function get() public view ret...
      SWAP1 			function get() public view ret...
      RETURN 			function get() public view ret...
    tag 3			function add( int x ) public {...
      JUMPDEST 			function add( int x ) public {...
      CALLVALUE 			function add( int x ) public {...
      DUP1 			olidity ^
      ISZERO 			a
      PUSH [tag] 7			a
      JUMPI 			a
      PUSH 0			a
      DUP1 			n
      REVERT 			.22;\ncontrac
    tag 7			a
      JUMPDEST 			a
      POP 			function add( int x ) public {...
      PUSH [tag] 8			function add( int x ) public {...
      PUSH 4			function add( int x ) public {...
      DUP1 			function add( int x ) public {...
      CALLDATASIZE 			function add( int x ) public {...
      SUB 			function add( int x ) public {...
      DUP2 			function add( int x ) public {...
      ADD 			function add( int x ) public {...
      SWAP1 			function add( int x ) public {...
      DUP1 			function add( int x ) public {...
      DUP1 			function add( int x ) public {...
      CALLDATALOAD 			function add( int x ) public {...
      SWAP1 			function add( int x ) public {...
      PUSH 20			function add( int x ) public {...
      ADD 			function add( int x ) public {...
      SWAP1 			function add( int x ) public {...
      SWAP3 			function add( int x ) public {...
      SWAP2 			function add( int x ) public {...
      SWAP1 			function add( int x ) public {...
      POP 			function add( int x ) public {...
      POP 			function add( int x ) public {...
      POP 			function add( int x ) public {...
      PUSH [tag] 9			function add( int x ) public {...
      JUMP 			function add( int x ) public {...
    tag 8			function add( int x ) public {...
      JUMPDEST 			function add( int x ) public {...
      STOP 			function add( int x ) public {...
    tag 6			function get() public view ret...
      JUMPDEST 			function get() public view ret...
      PUSH 0			int
      DUP1 			m
      SLOAD 			m
      SWAP1 			return m
      POP 			return m
      SWAP1 			function get() public view ret...
      JUMP [out]			function get() public view ret...
    tag 9			function add( int x ) public {...
      JUMPDEST 			function add( int x ) public {...
      PUSH E			14
      DUP2 			x
      PUSH 0			m
      SLOAD 			m
      ADD 			m + x
      ADD 			m + x + 14
      PUSH 0			m
      DUP2 			m = m + x + 14
      SWAP1 			m = m + x + 14
      SSTORE 			m = m + x + 14
      POP 			m = m + x + 14
      POP 			function add( int x ) public {...
      JUMP [out]			function add( int x ) public {...
    .data

```
CODECOPY表示拷贝代码

RETURN    表示执行到此处时整个流程结束


CALLVALUE 获取需要给合约转账的资产；如果是0，则直接进入tag1；否则revert ，因为构造函数没有payable修饰;所以该函数不能进行转账操作。

运行合约的时候，如果是第一次执行这个合约的时候，执行完构造函数内容后有个CODECOPY指令，作用是把后续的内容拷贝到覆盖构造函数的内容，然后返回合约写入statedb中


总结：
构造方法的参数在打包后添加到在字节码后面发送执行的

在"安装时间"和"运行时间"之间有一个强制的分离。无法运行构造器两次




